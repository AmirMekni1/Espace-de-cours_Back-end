const exp = require('express');
const router_Document =exp.Router();
const mult = require("multer");
const Document = require("../Models/Document")
const https = require('https');
const jwt = require("jsonwebtoken");


//______________________________________________________________________________________________________________________________________________




//______________________________________________________________________________________________________________________________________________


//recuperer image

photoname = "";
const mystorge = mult.diskStorage({
    destination: './Files',
    filename: (req, photo, redirect) => {
        L_date = Date.now();
        let f1 = L_date + "." + photo.mimetype.split('/')[1];
        redirect(null, f1);
        photoname = f1;
    }
});

 const upload = mult({ storage: mystorge });
//______________________________________________________________________________________________________________________________________________

function authenticateToken(req, res, next) {
    const token = req.header('Authorization');
    if (!token) {
      return res.status(401).json({ message: 'Token manquant' });
    }
    jwt.verify(token, "24884920", (err, user) => {
      if (err) {
        return res.status(403).json({ message: 'Acces rejected  !!!' });
      }
  
      next();
    });
  }



//______________________________________________________________________________________________________________________________________________
//ajouter Document
router_Document.post("/AjouterDoucument", upload.any('img'),  (req, res) => {
    const data = req.body;
    const po = new Document(data);
    po.Fichier=photoname;
    po.save().then(()=>{
        photoname=""
        res.send("ok");
    }).catch(()=>{
        res.send("erreur");
    });
}
);

//______________________________________________________________________________________________________________________________________________


//lister Documents
router_Document.get("/Lister/:Email", async (req, res) => {

    await Document.find({Email:req.params.Email}).then((result) => {
        res.status(200).send(result);
    }).catch(() => {
        res.status(500).send('error');
    });
});

//______________________________________________________________________________________________________________________________________________
    router_Document.get("/GetAllCardDocument/:id",authenticateToken, async (req, res) => {
        
           await Document.find({Email : req.params.id}).then((d)=>{
            res.status(200).send(d)
           }).catch((e)=>{
            res.status(500).send(e)
           })
          
      });

//______________________________________________________________________________________________________________________________________________

router_Document.delete("/deleteDocument/:id/:photo",authenticateToken, async (req,res)=>{
const x = await Document.findOneAndDelete({Email : req.params.id, image : req.params.photo })
if(x){
    res.status(200).send({Message : "ok"})
}else{
    res.status(500).send({Message : "erreur"})
}
})
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________

module.exports = router_Document;