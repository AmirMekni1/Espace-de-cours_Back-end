const exp = require('express');
const router_Matiere =exp.Router();
const mult = require("multer");
const Matiere = require("../Models/Matiere")
const https = require('https');
const jwt = require("jsonwebtoken");

//______________________________________________________________________________________________________________________________________________

//recuperer image

photoname = "";
const mystorge = mult.diskStorage({
    destination: './ImagesMatiere',
    filename: (req, photo, redirect) => {
        L_date = Date.now();
        let f1 = L_date + "." + photo.mimetype.split('/')[1];
        redirect(null, f1);
        photoname = f1;
    }
});


//______________________________________________________________________________________________________________________________________________

function authenticateToken(req, res, next) {
    const token = req.header('Authorization');
    if (!token) {
      return res.status(401).json({ message: 'Token manquant' });
    }
    jwt.verify(token, "24884920", (err, user) => {
      if (err) {
        return res.status(403).json({ message: 'Acces rejected  !!!' });
      }
  
      next();
    });
  }

const upload = mult({ storage: mystorge });

//______________________________________________________________________________________________________________________________________________
//ajouter matiere
router_Matiere.post("/ajouterMatiere", upload.any('img'),authenticateToken,  (req, res) => {
    const data = req.body;
    const matiere = new Matiere(data);
    matiere.image=photoname;
    const cle_ET = require("crypto").randomBytes(3).toString("hex")
    matiere.cle_Etudiant = cle_ET
    matiere.save().then(()=>{
        res.send("ok");
    }).catch(()=>{
        res.send("erreur");
    });
}
);

//______________________________________________________________________________________________________________________________________________


//lister matieres
router_Matiere.get("/Lister/:id", (req, res) => {
    Matiere.find({cle_Etudiant:req.params.id},{Les_Etudiants : 1}).then((result) => {
        res.send(result);
    }).catch(() => {
        res.send('error');
    });
});

//______________________________________________________________________________________________________________________________________________
    router_Matiere.get("/GetAllCardMatiere/:id",authenticateToken, async (req, res) => {
        console.log()
           await Matiere.find({Email : req.params.id}).then((d)=>{
            res.status(200).send(d)
           }).catch((e)=>{
            res.status(500).send(e)
           })
          
      });

//______________________________________________________________________________________________________________________________________________

router_Matiere.delete("/deleteMatiere/:id",authenticateToken, async (req,res)=>{
const x = await Matiere.findOneAndDelete({cle_Etudiant : req.params.id })
if(x){
    res.status(200).send({Message : "ok"})
}else{
    res.status(500).send({Message : "erreur"})
}
})

//______________________________________________________________________________________________________________________________________________

router_Matiere.get('/search/:query', async (req, res) => {
    const query = req.params.query;
  
    try {
      const results = await Matiere.find({
        $or: [
          {NomMatier : { $regex: query, $options: 'i' } }, // i: insensible Ã  la casse
          {Email : { $regex: query, $options: 'i' } },
          {image : { $regex: query, $options: 'i' } },
          {Classe : { $regex: query, $options: 'i' } },
          {cle_Etudiant : { $regex: query, $options: 'i' } },
        ],
      }).exec();
  
      res.json(results);
    } catch (err) {
      console.error(err);
      res.status(500).json({ error: 'Internal Server Error' });
    }
  });

//______________________________________________________________________________________________________________________________________________

router_Matiere.put("/AjouterEtudiant",async (req,res)=>{
  const result = await Matiere.findOneAndUpdate({cle_Etudiant : req.body},{ $push  : {Etudiants : req.body}}).then(()=>{

  }).catch(()=>{
    
  })
})

//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________

module.exports = router_Matiere;