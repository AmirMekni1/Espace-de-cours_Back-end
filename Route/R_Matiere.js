const exp = require('express');
const router_Matiere =exp.Router();
const mult = require("multer");
const Matiere = require("../Models/Matiere")
const https = require('https');
const jwt = require("jsonwebtoken");

//______________________________________________________________________________________________________________________________________________

//recuperer image

photoname = "";
const mystorge = mult.diskStorage({
    destination: './ImagesMatiere',
    filename: (req, photo, redirect) => {
        L_date = Date.now();
        let f1 = L_date + "." + photo.mimetype.split('/')[1];
        redirect(null, f1);
        photoname = f1;
    }
});




//______________________________________________________________________________________________________________________________________________

function authenticateToken(req, res, next) {
    const token = req.header('Authorization');
    if (!token) {
      return res.status(401).json({ message: 'Token manquant' });
    }
    jwt.verify(token, "24884920", (err, user) => {
      if (err) {
        return res.status(403).json({ message: 'Acces rejected  !!!' });
      }
  
      next();
    });
  }

const upload = mult({ storage: mystorge });

//______________________________________________________________________________________________________________________________________________
//ajouter matiere
router_Matiere.post("/ajouterMatiere", upload.any('img'),authenticateToken,  (req, res) => {
    const data = req.body;
    const matiere = new Matiere(data);
    matiere.image=photoname;
    matiere.save().then(()=>{
        res.send("ok");
    }).catch(()=>{
        res.send("erreur");
    });
}
);

//______________________________________________________________________________________________________________________________________________


//lister matieres
router_Matiere.get("/Lister", (req, res) => {
    Matiere.find().then((result) => {
        res.send(result);
    }).catch(() => {
        res.send('error');
    });
});

//______________________________________________________________________________________________________________________________________________
    router_Matiere.get("/GetAllCardMatiere/:id",authenticateToken, async (req, res) => {
        
           await Matiere.find({Email : req.params.id}).then((d)=>{
            res.status(200).send(d)
           }).catch((e)=>{
            res.status(500).send(e)
           })
          
      });

//______________________________________________________________________________________________________________________________________________

router_Matiere.delete("/deleteMatiere/:id/:photo", async (req,res)=>{
const x = await Matiere.findOneAndDelete({Email : req.params.id, image : req.params.photo })
if(x){
    res.status(200).send({Message : "ok"})
}else{
    res.status(500).send({Message : "erreur"})
}
})
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________

module.exports = router_Matiere;