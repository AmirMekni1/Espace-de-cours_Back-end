const exp = require('express');
const router_Classe =exp.Router();
const mult = require("multer");
const Classe = require("../Models/Classe")
const https = require('https');
const jwt = require("jsonwebtoken");


//______________________________________________________________________________________________________________________________________________




//______________________________________________________________________________________________________________________________________________


//recuperer image

photoname = "";
const mystorge = mult.diskStorage({
    destination: './ImagesClasse',
    filename: (req, photo, redirect) => {
        L_date = Date.now();
        let f1 = L_date + "." + photo.mimetype.split('/')[1];
        redirect(null, f1);
        photoname = f1;
    }
});


//______________________________________________________________________________________________________________________________________________

function authenticateToken(req, res, next) {
    const token = req.header('Authorization');
    if (!token) {
      return res.status(401).json({ message: 'Token manquant' });
    }
    jwt.verify(token, "24884920", (err, user) => {
      if (err) {
        return res.status(403).json({ message: 'Acces rejected  !!!' });
      }
  
      next();
    });
  }

const upload = mult({ storage: mystorge });

//______________________________________________________________________________________________________________________________________________
//ajouter Classe
router_Classe.post("/ajouterClasse", upload.any('img'),authenticateToken,  (req, res) => {
    const data = req.body;
    const po = new Classe(data);
    po.image=photoname;
    po.save().then(()=>{
        res.send("ok");
    }).catch(()=>{
        res.send("erreur");
    });
}
);

//______________________________________________________________________________________________________________________________________________


//lister Classes
router_Classe.get("/Lister", (req, res) => {
    Classe.find().then((result) => {
        res.send(result);
    }).catch(() => {
        res.send('error');
    });
});

//______________________________________________________________________________________________________________________________________________
    router_Classe.get("/GetAllCardClasse/:id",authenticateToken, async (req, res) => {
        
           await Classe.find({Email : req.params.id}).then((d)=>{
            res.status(200).send(d)
           }).catch((e)=>{
            res.status(500).send(e)
           })
          
      });

//______________________________________________________________________________________________________________________________________________

router_Classe.delete("/deleteClasse/:id/:photo",authenticateToken, async (req,res)=>{
const x = await Classe.findOneAndDelete({Email : req.params.id, image : req.params.photo })
if(x){
    res.status(200).send({Message : "ok"})
}else{
    res.status(500).send({Message : "erreur"})
}
})
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________
//______________________________________________________________________________________________________________________________________________

module.exports = router_Classe;